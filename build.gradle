group = 'com.fincher'

def baseNexusUrl = "http://192.168.1.2:8082/nexus/content/"


repositories {
  mavenLocal()
  maven {
        url "${baseNexusUrl}groups/public"
  }
}

buildscript {
  repositories {
    maven { url "https://plugins.gradle.org/m2/" }
  }
  dependencies {
    classpath 'com.google.protobuf:protobuf-gradle-plugin:0.8.12'
  }
}

apply plugin: 'java'
apply plugin: 'com.google.protobuf'
apply plugin: 'idea'
apply plugin: 'maven-publish'

dependencies {
  implementation 'com.google.protobuf:protobuf-java:3.0.0'
  implementation 'io.grpc:grpc-stub:1.0.0-pre2'
  implementation 'io.grpc:grpc-protobuf:1.0.0-pre2'
  if (JavaVersion.current().isJava9Compatible()) {
    // Workaround for @javax.annotation.Generated
    // see: https://github.com/grpc/grpc-java/issues/3633
    compile 'javax.annotation:javax.annotation-api:1.3.1'
  }
  
  implementation 'com.google.guava:guava:28.1-jre'
  implementation 'com.fincher:io-channel:2.0.2-SNAPSHOT'
  implementation 'org.apache.logging.log4j:log4j-api:2.13.1'
  implementation 'org.apache.logging.log4j:log4j-core:2.13.1'

  testCompile 'junit:junit:4.12'
  testCompile 'org.mockito:mockito-core:2.1.0'
  testCompile 'org.awaitility:awaitility:4.0.1'
}

protobuf {
  protoc {
    // The artifact spec for the Protobuf Compiler
    artifact = 'com.google.protobuf:protoc:3.0.0'
  }
  /*
  plugins {
    // Optional: an artifact spec for a protoc plugin, with "grpc" as
    // the identifier, which can be referred to in the "plugins"
    // container of the "generateProtoTasks" closure.
    grpc {
      artifact = 'io.grpc:protoc-gen-grpc-java:1.0.0-pre2'
    }
  }
  generateProtoTasks {
    ofSourceSet('main')*.plugins {
      // Apply the "grpc" plugin whose spec is defined above, without
      // options.  Note the braces cannot be omitted, otherwise the
      // plugin will not be added. This is because of the implicit way
      // NamedDomainObjectContainer binds the methods.
      grpc { }
    }
  }
  */
}

task sourcesJar(type: Jar) {
    from sourceSets.main.allJava
    archiveClassifier.set("sources")
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifact tasks.sourcesJar
        }
    }

    repositories {
        maven {
            credentials {
                username = "upload"
                password = "upload"
            }
        
            if (project.version.endsWith('-SNAPSHOT')) {
                url "${baseNexusUrl}repositories/snapshots"
            } else {
                url "${baseNexusUrl}repositories/releases"
            }
            authentication {
                basic(BasicAuthentication)
            }
        }
    }
}
